
# Read data
################################################################################

# Clear workspace
rm(list = ls())

# Packages
library(plyr)
library(dplyr)
library(RColorBrewer)

# Spatial packages
library(sp) # spTransform()
library(rgdal) # readOGR()
library(rgeos) # gCentroid(), gArea()

# Directories
gisdir <- "data/fao_stock_status/raw/FAO_AREAS"
statusdir <- "data/fao_stock_status/raw"
landingsdir <- "data/fao_landings/processed"
plotdir <- "RQ2/figures"

# Read data
load(paste(landingsdir, "1950_2017_FAO_landings_data_use.Rdata", sep="/"))
catch <- data; rm(data)
mfas <- read.csv(paste(statusdir, "FAO_major_fishing_area_centroids.csv", sep="/"), as.is=T)
bbmsy <- read.csv(paste(statusdir, "1950_2017_FAO_bbmsy_timeseries_cmsy13.csv", sep="/"), as.is=T)

# Read spatial data
wgs84 <- CRS("+proj=longlat +ellps=WGS84")
mfa <- readOGR(dsn=gisdir, layer="FAO_AREAS", verbose=F, stringsAsFactors=F)
mfa <- subset(mfa, F_LEVEL=="MAJOR")


# Build data
################################################################################

# Identify years of first exploitation
data <- bbmsy %>% 
  group_by(stockid) %>% 
  summarize(yr_dev = min(year[bbmsy_q50<1])) %>% 
  mutate(yr_dev=ifelse(is.infinite(yr_dev), NA, yr_dev)) %>% 
  # Add stock information
  left_join(stocks, by="stockid") %>% 
  # Add MFA centroids
  left_join(select(mfas, fao_area, fao_code, long_dd, lat_dd), by="fao_area") %>% 
  select(everything(), yr_dev)
  

# Visualize data
################################################################################

# Species sample size
nspp <- data %>% 
  group_by(sci_name_fb, comm_name) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n)) %>% 
  filter(n>=3)

# Add color to year of first development
nyr <- length(min(catch$year):max(catch$year))
colors <- colorRampPalette(brewer.pal(9,"YlOrRd"))(nyr)
data$color <- colors[data$yr_dev-1949]

# Plot data
figname <- "Fig1_seq_exploit_species.pdf"
pdf(paste(plotdir, figname, sep="/"), width=8.5, height=11)
par(mfrow=c(2,1))

# Loop through species: i <- 1
for(i in 1:nrow(nspp)){
  
  # Subset data
  spp <- nspp$sci_name_fb[i]
  sdata <- subset(data, sci_name_fb==spp)
  print(paste(i, spp))
  
  # Plot data
  plot(mfa, main=spp)
  points(x=sdata$long_dd, y=sdata$lat_dd, pch=16, col=sdata$color)
  text(x=sdata$long_dd, y=sdata$lat_dd, col=sdata$color, label=sdata$yr_dev, pos=4, cex=0.8)
  
}

# Off
dev.off()
graphics.off()



