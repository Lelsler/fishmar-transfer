
# Read data
################################################################################

# Clear workspace
rm(list = ls())

# Packages
library(plyr)
library(dplyr)
library(RColorBrewer)

# Spatial packages
library(sp) # spTransform()
library(rgdal) # readOGR()
library(rgeos) # gCentroid(), gArea()

# Directories
setwd("/Users/lauraelsler/Documents/SESYNC/Files/FISHMAR-data")

gisdir <- "rq2/co_variates_data/maps_data"
statusdir <- "fao_stock_status"
landingsdir <- "fao_landings"
plotdir <- "RQ2/figures"
tradedir <- "comtrade/processed/timeseries"

# Read data
load(paste(landingsdir, "1950_2017_FAO_landings_data_use.Rdata", sep="/"))
catch <- data; rm(data)
mfas <- read.csv(paste(gisdir, "country_centroids.csv", sep="/"), as.is=T)
mfas <- read.csv(paste(gisdir, "country_centroids.csv", sep="/"), as.is=T)
bbmsy <- read.csv(paste(statusdir, "1950_2017_FAO_bbmsy_timeseries_cmsy13.csv", sep="/"), as.is=T)
trade <- read.csv(paste(tradedir, "comtrade_1992_year1998_with_stocks.csv", sep="/"), as.is=T)

# Read spatial data
wgs84 <- CRS("+proj=longlat +ellps=WGS84")
mfa <- readOGR(dsn=gisdir, layer="country_centroids-point", verbose=F, stringsAsFactors=F)
#mfa <- subset(mfa, F_LEVEL=="MAJOR") 


# Build data
################################################################################
# Identify years of first exploitation
data <- trade %>% 
  group_by(stockid) %>% 
  summarize(yr_dev = min(year[super<1])) %>% 
  mutate(yr_dev=ifelse(is.infinite(yr_dev), NA, yr_dev)) %>% 
  select(everything(), yr_dev)
  # Add stock information
  left_join(stocks, by="stockid") %>% 
  # Add MFA centroids
  #left_join(select(longitude, latitude), by="iso3") %>% 
  left_join(x=trade, y=mfas[ , c("latitude","longitude","iso3")], by = "iso3", copy = TRUE, all = TRUE) %>% 
  #select(everything(), yr_dev)
  
  



# Identify years of first exploitation
data <- bbmsy %>% 
  group_by(stockid) %>% 
  summarize(yr_dev = min(year[bbmsy_q50<1])) %>% 
  mutate(yr_dev=ifelse(is.infinite(yr_dev), NA, yr_dev)) %>% 
  # Add stock information
  #left_join(stocks, by="stockid") %>% 
  # Add MFA centroids
  #left_join(select(mfas, fao_area, fao_code, long_dd, lat_dd), by="fao_area") %>% 
  #select(everything(), yr_dev)

# Visualize data
################################################################################

# Species sample size
nspp <- data %>% 
  group_by(sci_name_fb, comm_name) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n)) %>% 
  filter(n>=3)

# Add color to year of first development
nyr <- length(min(catch$year):max(catch$year))
colors <- colorRampPalette(brewer.pal(9,"YlOrRd")[3:9])(nyr)
data$color <- colors[data$yr_dev-1949]

# Plot data
figname <- "Fig1_seq_exploit_species.pdf"
pdf(paste(plotdir, figname, sep="/"), width=8.5, height=11)
par(mfrow=c(2,1))

# Loop through species: i <- 1
for(i in 1:nrow(nspp)){
  
  # Subset data
  spp <- nspp$sci_name_fb[i]
  comm_name <- nspp$comm_name[i]
  sdata <- subset(data, sci_name_fb==spp)
  print(paste(i, comm_name))
  
  # Plot map
  plot(mfa, main=paste0(comm_name, "\n", nspp$n[i], " stocks"), col="grey80")
  
  # Plot "fully developed" stocks
  points(x=sdata$long_dd, y=sdata$lat_dd, pch=16, col=sdata$color)
  text(x=sdata$long_dd, y=sdata$lat_dd, col=sdata$color, label=sdata$yr_dev, pos=4, cex=0.8)
  
  # Plot stocks not yet fully developed
  not_dev <- subset(sdata, is.na(yr_dev))
  if(nrow(not_dev)>0){
    points(x=not_dev$long_dd, y=not_dev$lat_dd, pch=16, col="black")
    text(x=not_dev$long_dd, y=not_dev$lat_dd, col="black", label="undeveloped", pos=4, cex=0.8)
  }
  
}

# Off
dev.off()
graphics.off()



